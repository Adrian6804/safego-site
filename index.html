// Constantele de configurare API
const API_BASE_URL = 'https://insuretech.staging.insuretech.ro/api/v1';
const API_KEY = '015f40fc-1974-4ad5-bbde-48c117a54307';

async function getQuotes() {
    const plate = document.getElementById('plate').value;
    const cnp = document.getElementById('cnp').value;

    if(!plate || !cnp) {
        alert("Te rugăm să introduci numărul de înmatriculare și CNP-ul.");
        return;
    }

    // Interfața: Trecem la starea de încărcare
    document.getElementById('step-form').classList.add('hidden');
    document.getElementById('step-loading').classList.remove('hidden');

    try {
        const response = await fetch(`${API_BASE_URL}/rca/quotes`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-API-KEY': API_KEY // Unele API-uri folosesc X-API-KEY sau Bearer
            },
            body: JSON.stringify({
                registration_number: plate,
                owner_id: cnp
            })
        });

        const data = await response.json();

        if (response.ok) {
            renderOffers(data.data || data.offers); // Adaptăm în funcție de structura răspunsului
        } else {
            throw new Error(data.message || "Nu am putut obține ofertele.");
        }

    } catch (error) {
        console.error("Eroare API:", error);
        alert("Eroare la conectare: " + error.message);
        resetToForm();
    }
}

function renderOffers(offers) {
    const list = document.getElementById('offers-list');
    list.innerHTML = ''; // Curățăm ofertele vechi

    document.getElementById('step-loading').classList.add('hidden');
    document.getElementById('step-results').classList.remove('hidden');

    if (!offers || offers.length === 0) {
        list.innerHTML = '<p class="text-center text-zinc-500 uppercase font-black text-xs py-10">Nu am găsit oferte pentru aceste date.</p>';
        return;
    }

    offers.forEach(offer => {
        const card = `
            <div class="offer-card flex justify-between items-center bg-zinc-900/50 p-5 rounded-2xl border border-white/5 mb-3">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center text-black font-bold text-[8px] text-center p-1">
                        ${offer.insurer_name}
                    </div>
                    <div>
                        <p class="font-black text-xs uppercase text-white">${offer.insurer_name}</p>
                        <p class="text-[9px] text-zinc-500 uppercase">Perioadă: ${offer.period} Luni</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-xl font-black text-[#39ff14]">${offer.price} ${offer.currency}</p>
                    <button onclick="initiateOrder('${offer.id}')" class="text-[9px] font-black uppercase bg-[#39ff14] text-black px-4 py-2 rounded-full mt-2">
                        Cumpără
                    </button>
                </div>
            </div>
        `;
        list.innerHTML += card;
    });
}

function resetToForm() {
    document.getElementById('step-loading').classList.add('hidden');
    document.getElementById('step-results').classList.add('hidden');
    document.getElementById('step-form').classList.remove('hidden');
}
